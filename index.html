<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西北社區財務系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (圖示) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts (Noto Sans TC) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK (使用兼容版本以確保穩定性) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        /* 自定義滾動條樣式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        /* 載入動畫 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #dc2626; /* Red-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 overflow-hidden h-screen">

    <!-- 1. 登入頁面容器 -->
    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-200" style="background-image: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); visibility:hidden;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md border-t-4 border-red-700">
            <div class="text-center mb-8">
                <div id="login-logo" class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-700 mb-4">
                    <i class="fa-solid fa-building-columns text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">西北社區財務系統</h1>
                <p class="text-gray-500 text-sm mt-1">西北好用心    住戶更安心</p>
            </div>

            <form id="login-form" class="space-y-6">
                <div>
                    <div class="flex items-center justify-between">
                        <label for="email" class="block text-sm font-medium text-gray-700">電子郵件</label>
                        <label class="inline-flex items-center text-sm text-gray-600">
                            <input type="checkbox" id="remember-me" class="mr-2 rounded border-gray-300">
                            記住我
                        </label>
                    </div>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fa-solid fa-envelope text-gray-400"></i>
                        </div>
                        <input type="email" id="email" class="focus:ring-red-500 focus:border-red-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-md p-2 border" placeholder="admin@northwest.com" required>
                    </div>
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">密碼</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fa-solid fa-lock text-gray-400"></i>
                        </div>
                        <input type="password" id="password" class="focus:ring-red-500 focus:border-red-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-md p-2 border pr-10" placeholder="••••••••" required>
                        <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                            <i class="fa-solid fa-eye-slash"></i>
                        </button>
                    </div>
                </div>


                <div id="login-error" class="text-red-600 text-sm hidden">
                    <i class="fa-solid fa-circle-exclamation mr-1"></i> 帳號或密碼錯誤
                </div>

                <button type="submit" id="login-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-700 hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                    登入系統
                </button>
                
                <div id="diagnose-output" class="mt-2 hidden text-xs bg-gray-50 border border-gray-200 rounded p-3 text-gray-700"></div>
            </form>
            <div class="mt-6 text-center text-xs text-gray-400">
                &copy; 2025 西北保全
            </div>
        </div>
    </div>

    <!-- 2. 主系統介面容器 (登入後顯示) -->
    <div id="main-app" class="flex h-screen hidden">
        
        <!-- 左側導覽列 (10% 寬度) -->
        <aside class="w-[15%] bg-red-900 text-white flex flex-col shadow-lg relative z-20 min-w-[100px]">
            <div class="flex flex-col h-full">
                <div id="main-logo" class="h-[10%] box-border flex-none flex items-center justify-center px-6 border-b border-red-800 bg-red-950">
                    <i class="fa-solid fa-shield-halved text-[28px] text-red-100"></i>
                </div>
                <div class="h-[10%] box-border flex-none flex items-center justify-center">
                    <span id="sidebar-community-name" class="text-[20px] font-bold text-red-100 cursor-pointer">西北保全社區</span>
                </div>
                <div class="h-[10%] box-border flex-none">
                    <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item w-full h-full flex flex-row items-center justify-center gap-2 text-red-100 hover:bg-red-800 hover:text-white transition-colors border-l-4 border-transparent bg-red-800 border-white">
                        <i class="fa-solid fa-chart-pie text-[20px]"></i>
                        <span class="text-[20px]">總覽</span>
                    </a>
                </div>
                <div class="h-[10%] box-border flex-none">
                    <a href="#" onclick="switchTab('income')" id="nav-income" class="nav-item w-full h-full flex flex-row items-center justify-center gap-2 text-red-100 hover:bg-red-800 hover:text-white transition-colors border-l-4 border-transparent">
                        <i class="fa-solid fa-hand-holding-dollar text-[20px]"></i>
                        <span class="text-[20px]">收入</span>
                    </a>
                </div>
                <div class="h-[10%] box-border flex-none">
                    <a href="#" onclick="switchTab('expense')" id="nav-expense" class="nav-item w-full h-full flex flex-row items-center justify-center gap-2 text-red-100 hover:bg-red-800 hover:text-white transition-colors border-l-4 border-transparent">
                        <i class="fa-solid fa-file-invoice-dollar text-[20px]"></i>
                        <span class="text-[20px]">支出</span>
                    </a>
                </div>
                <div class="h-[10%] box-border flex-none">
                    <a href="#" onclick="switchTab('bank')" id="nav-bank" class="nav-item w-full h-full flex flex-row items-center justify-center gap-2 text-red-100 hover:bg-red-800 hover:text-white transition-colors border-l-4 border-transparent">
                        <i class="fa-solid fa-building-columns text-[20px]"></i>
                        <span class="text-[20px]">銀行</span>
                    </a>
                </div>
                <div class="h-[10%] box-border flex-none">
                    <a href="#" onclick="switchTab('residents')" id="nav-residents" class="nav-item w-full h-full flex flex-row items-center justify-center gap-2 text-red-100 hover:bg-red-800 hover:text-white transition-colors border-l-4 border-transparent">
                        <i class="fa-solid fa-users text-[20px]"></i>
                        <span class="text-[20px]">住戶</span>
                    </a>
                </div>
                <div class="h-[10%] box-border flex-none">
                    <a href="#" onclick="switchTab('reports')" id="nav-reports" class="nav-item w-full h-full flex flex-row items-center justify-center gap-2 text-red-100 hover:bg-red-800 hover:text-white transition-colors border-l-4 border-transparent">
                        <i class="fa-solid fa-chart-line text-[20px]"></i>
                        <span class="text-[20px]">報表</span>
                    </a>
                </div>
                <div class="h-[10%] box-border flex-none">
                    <a href="#" onclick="switchTab('settings')" id="nav-settings" class="nav-item w-full h-full flex flex-row items-center justify-center gap-2 text-red-100 hover:bg-red-800 hover:text-white transition-colors border-l-4 border-transparent">
                        <i class="fa-solid fa-gear text-[20px]"></i>
                        <span class="text-[20px]">設定</span>
                    </a>
                </div>
                <div class="h-[10%] border-t border-red-800">
                    <button onclick="logout()" class="w-full h-full flex flex-row items-center justify-center gap-2 text-red-100 hover:bg-red-800 hover:text-white transition-colors border-l-4 border-transparent">
                        <i class="fa-solid fa-right-from-bracket text-[20px]"></i>
                        <span class="text-[20px]">登出</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- 右側主要內容 (90% 寬度) -->
        <main class="w-[85%] flex flex-col bg-gray-50 relative">
            <!-- R01 標題列 -->
            <header class="h-[10%] box-border flex-none bg-white shadow-sm flex items-center justify-between px-6 border-b border-gray-200">
                <h2 id="page-title" class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fa-solid fa-chart-pie mr-2 text-red-600"></i>
                    財務總覽
                </h2>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                        <i class="fa-regular fa-clock mr-1"></i> <span id="current-date">2023-10-27</span>
                    </span>
                    <span id="connection-status" class="text-sm px-3 py-1 rounded-full"></span>
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-red-600 text-white flex items-center justify-center text-sm font-bold mr-2">
                            A
                        </div>
                        <span class="text-sm font-medium text-gray-700" id="user-display-name">管理員</span>
                    </div>
                </div>
            </header>

            <!-- R02 子分頁按鈕列 -->
            <div id="subtab-bar" class="h-[10%] bg-white border-b border-gray-200 px-6 flex items-center gap-4"></div>

            <!-- R03~R10 10% 列結構，用於與左側對齊 -->
            <div class="h-[10%] border-b border-gray-100"></div>
            <div class="h-[10%] border-b border-gray-100"></div>
            <div class="h-[10%] border-b border-gray-100"></div>
            <div class="h-[10%] border-b border-gray-100"></div>
            <div class="h-[10%] border-b border-gray-100"></div>
            <div class="h-[10%] border-b border-gray-100"></div>
            <div class="h-[10%] border-b border-gray-100"></div>
            <div class="h-[10%]"></div>

            <!-- 子分頁內容覆蓋於 R03~R10 區域，保持列高 1:1 對齊 -->
            <div id="right-content" class="absolute inset-x-0 top-[20%] bottom-0 overflow-auto p-6">
                <!-- 載入指示器 -->
                <div id="content-loader" class="hidden absolute inset-0 bg-white/50 flex items-center justify-center z-10">
                    <div class="loader"></div>
                </div>

                <!-- 1. 儀表板視圖 (Dashboard) -->
                <div id="view-dashboard" class="content-view space-y-6">
                    <!-- 數據卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white rounded-lg p-5 shadow-sm border-l-4 border-red-600">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-medium text-gray-500 uppercase">本月總收入</p>
                                    <h3 class="text-2xl font-bold text-gray-800 mt-1">$158,200</h3>
                                </div>
                                <div class="p-2 bg-red-50 rounded-lg text-red-600">
                                    <i class="fa-solid fa-arrow-trend-up"></i>
                                </div>
                            </div>
                            <p class="text-xs text-green-600 mt-2 flex items-center">
                                <i class="fa-solid fa-caret-up mr-1"></i> 較上月 +5.2%
                            </p>
                        </div>

                        <div class="bg-white rounded-lg p-5 shadow-sm border-l-4 border-gray-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-medium text-gray-500 uppercase">本月總支出</p>
                                    <h3 class="text-2xl font-bold text-gray-800 mt-1">$42,500</h3>
                                </div>
                                <div class="p-2 bg-gray-100 rounded-lg text-gray-600">
                                    <i class="fa-solid fa-arrow-trend-down"></i>
                                </div>
                            </div>
                            <p class="text-xs text-red-500 mt-2 flex items-center">
                                <i class="fa-solid fa-caret-up mr-1"></i> 較上月 +1.2%
                            </p>
                        </div>

                        <div class="bg-white rounded-lg p-5 shadow-sm border-l-4 border-red-800">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-medium text-gray-500 uppercase">目前結餘</p>
                                    <h3 class="text-2xl font-bold text-red-800 mt-1">$2,105,700</h3>
                                </div>
                                <div class="p-2 bg-red-50 rounded-lg text-red-800">
                                    <i class="fa-solid fa-piggy-bank"></i>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">包含定存與活儲</p>
                        </div>
                        
                        <div class="bg-white rounded-lg p-5 shadow-sm border-l-4 border-orange-400">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-medium text-gray-500 uppercase">未繳管理費</p>
                                    <h3 class="text-2xl font-bold text-gray-800 mt-1">5 戶</h3>
                                </div>
                                <div class="p-2 bg-orange-50 rounded-lg text-orange-400">
                                    <i class="fa-solid fa-circle-exclamation"></i>
                                </div>
                            </div>
                            <p class="text-xs text-orange-500 mt-2 cursor-pointer hover:underline">查看名單</p>
                        </div>
                    </div>

                    <!-- 最近交易表格 -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-lg">
                            <h3 class="font-bold text-gray-700">最近收支紀錄</h3>
                            <button class="text-sm text-red-600 hover:text-red-800 font-medium">查看全部</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-600">
                                <thead class="bg-gray-100 text-gray-700 uppercase text-xs font-bold">
                                    <tr>
                                        <th class="px-6 py-3">日期</th>
                                        <th class="px-6 py-3">項目/摘要</th>
                                        <th class="px-6 py-3">類型</th>
                                        <th class="px-6 py-3">經手人</th>
                                        <th class="px-6 py-3 text-right">金額</th>
                                        <th class="px-6 py-3 text-center">狀態</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="transaction-list">
                                    <tr>
                                        <td class="px-6 py-4">2023-10-26</td>
                                        <td class="px-6 py-4 font-medium text-gray-800">10月份管理費 - A棟5樓</td>
                                        <td class="px-6 py-4"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">收入</span></td>
                                        <td class="px-6 py-4">總幹事</td>
                                        <td class="px-6 py-4 text-right text-green-600 font-bold">+$2,500</td>
                                        <td class="px-6 py-4 text-center"><i class="fa-solid fa-circle-check text-green-500"></i></td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4">2023-10-25</td>
                                        <td class="px-6 py-4 font-medium text-gray-800">公共區域清潔費 (10月)</td>
                                        <td class="px-6 py-4"><span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">支出</span></td>
                                        <td class="px-6 py-4">財委</td>
                                        <td class="px-6 py-4 text-right text-red-600 font-bold">-$12,000</td>
                                        <td class="px-6 py-4 text-center"><i class="fa-solid fa-circle-check text-green-500"></i></td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4">2023-10-24</td>
                                        <td class="px-6 py-4 font-medium text-gray-800">電梯保養費 (第3季)</td>
                                        <td class="px-6 py-4"><span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">支出</span></td>
                                        <td class="px-6 py-4">財委</td>
                                        <td class="px-6 py-4 text-right text-red-600 font-bold">-$8,500</td>
                                        <td class="px-6 py-4 text-center"><i class="fa-solid fa-circle-check text-green-500"></i></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 2. 其他視圖佔位符 (Other Views Placeholder) -->
                <div id="view-income" class="content-view hidden">
                    <div id="income-detail-view" class="bg-white p-8 rounded-lg shadow-sm">
                        <div class="text-center">
                            <i class="fa-solid fa-hand-holding-dollar text-4xl text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700">收入明細</h3>
                            <p class="text-gray-500 mt-2">此處顯示收入記錄與查詢。</p>
                        </div>
                    </div>
                    <div id="income-settings-view" class="space-y-6 hidden">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-lg">
                                <h3 class="font-bold text-gray-700">固定收入列表</h3>
                                <button id="btn-add-income-fixed" class="px-3 py-2 bg-red-600 text-white rounded">新增</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm text-gray-600">
                                    <thead class="bg-gray-100 text-gray-700 uppercase text-xs font-bold">
                                        <tr>
                                            <th class="px-6 py-3">項目</th>
                                            <th class="px-6 py-3">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="income-fixed-tbody" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-lg">
                                <h3 class="font-bold text-gray-700">其他收入列表</h3>
                                <button id="btn-add-income-other" class="px-3 py-2 bg-red-600 text-white rounded">新增</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm text-gray-600">
                                    <thead class="bg-gray-100 text-gray-700 uppercase text-xs font-bold">
                                        <tr>
                                            <th class="px-6 py-3">項目</th>
                                            <th class="px-6 py-3">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="income-other-tbody" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-expense" class="content-view hidden">
                    <div id="expense-detail-view" class="bg-white p-8 rounded-lg shadow-sm">
                        <div class="text-center">
                            <i class="fa-solid fa-file-invoice-dollar text-4xl text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700">支出明細</h3>
                            <p class="text-gray-500 mt-2">此處顯示支出記錄與查詢。</p>
                        </div>
                    </div>
                    <div id="expense-settings-view" class="space-y-6 hidden">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-lg">
                                <h3 class="font-bold text-gray-700">固定支出列表</h3>
                                <button id="btn-add-expense-fixed" class="px-3 py-2 bg-red-600 text-white rounded">新增</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm text-gray-600">
                                    <thead class="bg-gray-100 text-gray-700 uppercase text-xs font-bold">
                                        <tr>
                                            <th class="px-6 py-3">項目</th>
                                            <th class="px-6 py-3">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expense-fixed-tbody" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-lg">
                                <h3 class="font-bold text-gray-700">其他支出列表</h3>
                                <button id="btn-add-expense-other" class="px-3 py-2 bg-red-600 text-white rounded">新增</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm text-gray-600">
                                    <thead class="bg-gray-100 text-gray-700 uppercase text-xs font-bold">
                                        <tr>
                                            <th class="px-6 py-3">項目</th>
                                            <th class="px-6 py-3">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expense-other-tbody" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                 <div id="view-reports" class="content-view hidden">
                    <div class="bg-white p-8 rounded-lg shadow-sm text-center">
                        <i class="fa-solid fa-chart-line text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-700">財務報表中心</h3>
                        <p class="text-gray-500 mt-2">月報表、季報表與年度預算執行率分析。</p>
                    </div>
                </div>

                <div id="view-bank" class="content-view hidden">
                    <div id="bank-detail-view" class="bg-white p-8 rounded-lg shadow-sm">
                        <div class="text-center">
                            <i class="fa-solid fa-building-columns text-4xl text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700">銀行明細</h3>
                            <p class="text-gray-500 mt-2">此處顯示銀行相關查詢。</p>
                        </div>
                    </div>
                    <div id="bank-settings-view" class="space-y-6 hidden">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-lg">
                                <h3 class="font-bold text-gray-700">銀行列表</h3>
                                <button id="btn-add-bank" class="px-3 py-2 bg-red-600 text-white rounded">新增</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm text-gray-600">
                                    <thead class="bg-gray-100 text-gray-700 uppercase text-xs font-bold">
                                        <tr>
                                            <th class="px-6 py-3">銀行名稱</th>
                                            <th class="px-6 py-3">分行名稱</th>
                                            <th class="px-6 py-3">戶名</th>
                                            <th class="px-6 py-3">帳號</th>
                                            <th class="px-6 py-3">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bank-tbody" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-residents" class="content-view hidden">
                    <div id="residents-detail-view" class="bg-white p-8 rounded-lg shadow-sm">
                        <div class="text-center">
                            <i class="fa-solid fa-users text-4xl text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700">住戶明細</h3>
                            <p class="text-gray-500 mt-2">此處顯示住戶相關資料與查詢。</p>
                        </div>
                    </div>
                    <div id="residents-settings-view" class="space-y-6 hidden">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-lg">
                                <h3 class="font-bold text-gray-700">社區分棟列表</h3>
                                <button id="btn-add-building" class="px-3 py-2 bg-red-600 text-white rounded">新增</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm text-gray-600">
                                    <thead class="bg-gray-100 text-gray-700 uppercase text-xs font-bold">
                                        <tr>
                                            <th class="px-6 py-3">分棟名稱</th>
                                            <th class="px-6 py-3">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="residents-buildings-tbody" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-settings" class="content-view hidden">
                    <div class="bg-white p-8 rounded-lg shadow-sm text-center">
                        <i class="fa-solid fa-gear text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-700">系統設定</h3>
                        <p class="text-gray-500 mt-2">此處將顯示使用者偏好與系統參數。</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden z-[60]">
        <div class="absolute inset-0 bg-white flex flex-col">
            <div class="h-14 flex items-center justify-between px-6 border-b">
                <div class="flex items-center gap-4">
                    <button id="settings-tab-accounts" class="px-3 py-1 border-b-2 border-transparent text-gray-700">帳號設定</button>
                    <button id="settings-tab-communities" class="px-3 py-1 border-b-2 border-transparent text-gray-700">社區設定</button>
                </div>
                <button id="settings-close" class="text-gray-600 hover:text-red-700"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="settings-error" class="px-6 py-2 text-sm text-orange-700 bg-orange-50 border-b hidden">雲端權限不足或讀取失敗，改用本機設定</div>
            <div class="flex-1 overflow-auto p-6">
                <div id="settings-view-accounts" class="space-y-4 hidden">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-800">帳號列表</h3>
                        <button id="btn-add-account" class="px-3 py-2 bg-red-600 text-white rounded">新增</button>
                    </div>
                    <div class="border rounded-lg overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 text-gray-700">
                                <tr>
                                    <th class="px-4 py-2 text-left">帳號編號</th>
                                    <th class="px-4 py-2 text-left">社區名稱</th>
                                    <th class="px-4 py-2 text-left">姓名</th>
                                    <th class="px-4 py-2 text-left">電子郵件</th>
                                    <th class="px-4 py-2 text-left">手機號碼</th>
                                    <th class="px-4 py-2 text-left">操作</th>
                                </tr>
                            </thead>
                            <tbody id="accounts-tbody" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>

                <div id="settings-view-communities" class="space-y-4 hidden">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-800">社區列表</h3>
                        <button id="btn-add-community" class="px-3 py-2 bg-red-600 text-white rounded">新增</button>
                    </div>
                    <div class="border rounded-lg overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 text-gray-700">
                                <tr>
                                    <th class="px-4 py-2 text-left">社區編號</th>
                                    <th class="px-4 py-2 text-left">社區名稱</th>
                                    <th class="px-4 py-2 text-left">操作</th>
                                </tr>
                            </thead>
                            <tbody id="communities-tbody" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-add-account" class="fixed inset-0 hidden z-[70]"> 
            <div class="absolute inset-0 bg-black/40"></div>
            <div class="absolute inset-0 flex items-center justify中心 p-6">
                <div class="bg-white rounded-lg w-full max-w-lg p-6 space-y-4">
                    <h4 class="text-lg font-bold">新增帳號</h4>
                    <div>
                        <label class="block text-sm mb-1">社區名稱</label>
                        <select id="input-account-community" class="w-full border rounded px-3 py-2"></select>
                    </div>
                    <div>
                        <label class="block text-sm mb-1">姓名</label>
                        <input id="input-account-name" class="w-full border rounded px-3 py-2" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">電子郵件 (預設帳號)</label>
                        <input id="input-account-email" type="email" class="w-full border rounded px-3 py-2" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">手機號碼 (預設密碼)</label>
                        <input id="input-account-phone" class="w-full border rounded px-3 py-2" />
                    </div>
                    <div class="flex justify-end gap-2">
                        <button id="cancel-add-account" class="px-3 py-2 border rounded">取消</button>
                        <button id="confirm-add-account" class="px-3 py-2 bg-red-600 text-white rounded">新增</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-add-community" class="fixed inset-0 hidden z-[70]"> 
            <div class="absolute inset-0 bg-black/40"></div>
            <div class="absolute inset-0 flex items-center justify-center p-6">
                <div class="bg-white rounded-lg w-full max-w-lg p-6 space-y-4">
                    <h4 class="text-lg font-bold">新增社區</h4>
                    <div>
                        <label class="block text-sm mb-1">社區編號</label>
                        <input id="input-community-code" class="w-full border rounded px-3 py-2" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">社區名稱</label>
                        <input id="input-community-name" class="w-full border rounded px-3 py-2" />
                    </div>
                    <div class="flex justify-end gap-2">
                        <button id="cancel-add-community" class="px-3 py-2 border rounded">取消</button>
                        <button id="confirm-add-community" class="px-3 py-2 bg-red-600 text-white rounded">新增</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-settings-password" class="fixed inset-0 hidden z-[65]">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="absolute inset-0 flex items-center justify-center p-6">
            <div class="bg-white rounded-lg w-full max-w-sm p-6 space-y-4">
                <h4 class="text-lg font-bold">輸入設定密碼</h4>
                <input id="settings-pass-input" type="password" class="w-full border rounded px-3 py-2" placeholder="密碼" />
                <p id="settings-pass-error" class="text-sm text-red-600 hidden">密碼錯誤</p>
                <div class="flex justify-end gap-2">
                    <button id="settings-pass-cancel" class="px-3 py-2 border rounded">取消</button>
                    <button id="settings-pass-confirm" class="px-3 py-2 bg-red-600 text-white rounded">確認</button>
                </div>
            </div>
        </div>
    </div>

        <div id="community-switcher-modal" class="fixed inset-0 hidden z-[66]">
            <div class="absolute inset-0 bg-black/40"></div>
            <div class="absolute inset-0 flex items-center justify-center p-6">
                <div class="bg-white rounded-lg w-full max-w-2xl p-6 space-y-4">
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-bold">選擇社區</h4>
                        <button id="community-switcher-close" class="text-gray-600 hover:text-red-700"><i class="fa-solid fa-xmark text-xl"></i></button>
                    </div>
                    <div id="community-switcher-list" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                </div>
            </div>
        </div>

        <div id="modal-edit-item" class="fixed inset-0 hidden z-[70]">
            <div class="absolute inset-0 bg-black/40"></div>
            <div class="absolute inset-0 flex items-center justify-center p-6">
                <div class="bg-white rounded-lg w-full max-w-sm p-6 space-y-4">
                    <h4 class="text-lg font-bold">輸入項目</h4>
                    <input id="input-item-name" class="w-full border rounded px-3 py-2" placeholder="項目" />
                    <div class="flex justify-end gap-2">
                        <button id="cancel-edit-item" class="px-3 py-2 border rounded">取消</button>
                        <button id="confirm-edit-item" class="px-3 py-2 bg-red-600 text-white rounded">確認</button>
        </div>

        <div id="modal-edit-bank" class="fixed inset-0 hidden z-[70]">
            <div class="absolute inset-0 bg-black/40"></div>
            <div class="absolute inset-0 flex items-center justify-center p-6">
                <div class="bg-white rounded-lg w-full max-w-lg p-6 space-y-4">
                    <h4 class="text-lg font-bold">輸入銀行資料</h4>
                    <div>
                        <label class="block text-sm mb-1">銀行名稱</label>
                        <input id="input-bank-name" class="w-full border rounded px-3 py-2" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">分行名稱</label>
                        <input id="input-bank-branch" class="w-full border rounded px-3 py-2" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">戶名</label>
                        <input id="input-bank-holder" class="w-full border rounded px-3 py-2" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">帳號</label>
                        <input id="input-bank-account" class="w-full border rounded px-3 py-2" />
                    </div>
                    <div class="flex justify-end gap-2">
                        <button id="cancel-edit-bank" class="px-3 py-2 border rounded">取消</button>
                        <button id="confirm-edit-bank" class="px-3 py-2 bg-red-600 text-white rounded">確認</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-edit-building" class="fixed inset-0 hidden z-[70]">
            <div class="absolute inset-0 bg-black/40"></div>
            <div class="absolute inset-0 flex items-center justify-center p-6">
                <div class="bg-white rounded-lg w-full max-w-sm p-6 space-y-4">
                    <h4 class="text-lg font-bold">輸入分棟名稱</h4>
                    <input id="input-building-name" class="w-full border rounded px-3 py-2" placeholder="分棟名稱" />
                    <div class="flex justify-end gap-2">
                        <button id="cancel-edit-building" class="px-3 py-2 border rounded">取消</button>
                        <button id="confirm-edit-building" class="px-3 py-2 bg-red-600 text-white rounded">確認</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
            </div>
        </div>


    <script>
        // ==========================================
        // Firebase 設定與初始化
        // ==========================================
        
        // 注意：在真實專案中，建議將此部分配置移至外部 config.js 檔案
        // 為了讓此範例可直接運行，我們優先檢查環境變數
        
        let firebaseConfig = {};
        let appId = 'default-app';

        // 檢查環境是否提供了配置 (用於預覽環境)
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if(typeof __app_id !== 'undefined') appId = __app_id;
        } else {
            // [使用者需在此填入自己的 Firebase 配置]
            // 如果您要部署到 GitHub Pages，請取消註解並填入您的金鑰
            /*
            firebaseConfig = {
                apiKey: "您的API_KEY",
                authDomain: "您的專案ID.firebaseapp.com",
                projectId: "您的專案ID",
                storageBucket: "您的專案ID.appspot.com",
                messagingSenderId: "您的SENDER_ID",
                appId: "您的APP_ID"
            };
            */
           console.warn("未檢測到 Firebase Config，使用 UI 演示模式");
        }

        // 初始化 Firebase (如果有配置)
        let app, auth, db;
        let cloudAvailable = true;
        let isDemoMode = false;

        if (typeof __force_demo_mode !== 'undefined' && __force_demo_mode) {
            isDemoMode = true;
        }
        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                console.log("Firebase initialized successfully");
                // 確保有身份以便讀取雲端設定
                // 若尚未登入，進行匿名登入（需在 Firebase Console 啟用 Anonymous）
                if (!isDemoMode) {
                    (async ()=>{ try { if (!auth.currentUser) { await auth.signInAnonymously(); localStorage.setItem('lastLoginMode','anonymous'); } } catch(e){ console.warn('Anonymous sign-in failed:', e); } })();
                }
            } else {
                isDemoMode = true; // 如果沒有金鑰，進入純前端演示模式
            }
        } catch (e) {
            console.error("Firebase init error:", e);
            isDemoMode = true;
        }

        function updateConnectionStatus() {
            const el = document.getElementById('connection-status');
            if (!el) return;
            el.className = 'text-sm px-3 py-1 rounded-full';
            if (isDemoMode) {
                el.classList.add('bg-orange-100','text-orange-700');
                el.innerHTML = '<i class="fa-solid fa-wifi-slash mr-1"></i> 預覽模式';
            } else {
                el.classList.add('bg-green-100','text-green-700');
                el.innerHTML = '<i class="fa-solid fa-cloud mr-1"></i> 已連線';
            }
        }
        updateConnectionStatus();

        // ==========================================
        // 應用程式邏輯
        // ==========================================

        // 設定日期
        const today = new Date();
        document.getElementById('current-date').textContent = today.toISOString().split('T')[0];

        // UI 參考
        const loginView = document.getElementById('login-view');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginBtn = document.getElementById('login-btn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const rememberMe = document.getElementById('remember-me');

        const persistedLogin = localStorage.getItem('persistLogin') === 'true';
        const lastLoginMode = localStorage.getItem('lastLoginMode');
        if (persistedLogin) {
            if (lastLoginMode === 'demo') isDemoMode = true;
            enterApp();
        } else {
            if (loginView) loginView.style.visibility = 'visible';
        }

        function setLoginLoading(loading) {
            if (!loginBtn) return;
            if (loading) {
                loginBtn.disabled = true;
                loginBtn.classList.add('opacity-60','cursor-not-allowed');
                loginBtn.textContent = '登入中...';
            } else {
                loginBtn.disabled = false;
                loginBtn.classList.remove('opacity-60','cursor-not-allowed');
                loginBtn.textContent = '登入系統';
            }
        }

        if (rememberMe) {
            const savedRemember = localStorage.getItem('rememberMe') === 'true';
            if (savedRemember && emailInput) {
                emailInput.value = localStorage.getItem('rememberEmail') || '';
                rememberMe.checked = true;
            }
        }

        if (togglePasswordBtn && passwordInput) {
            togglePasswordBtn.addEventListener('click', () => {
                const isHidden = passwordInput.getAttribute('type') === 'password';
                passwordInput.setAttribute('type', isHidden ? 'text' : 'password');
                const icon = togglePasswordBtn.querySelector('i');
                if (icon) {
                    icon.classList.remove(isHidden ? 'fa-eye-slash' : 'fa-eye');
                    icon.classList.add(isHidden ? 'fa-eye' : 'fa-eye-slash');
                }
            });
        }

        // 1. 處理登入
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = (emailInput.value || '').trim();
            const password = (passwordInput.value || '').trim();
            if (rememberMe && rememberMe.checked) {
                localStorage.setItem('rememberMe', 'true');
                localStorage.setItem('rememberEmail', email);
            } else {
                localStorage.removeItem('rememberMe');
                localStorage.removeItem('rememberEmail');
            }
            setLoginLoading(true);

            // 先嘗試本機帳號登入（使用手機號碼作為預設密碼）
            if (!navigator.onLine) {
                isDemoMode = true;
                loginError.classList.remove('hidden');
                loginError.innerHTML = `<i class="fa-solid fa-circle-exclamation mr-1"></i> 網路離線，進入預覽模式`;
                setCurrentCommunityByEmailAsync(email).then(()=> setTimeout(() => enterApp(), 300));
                updateConnectionStatus();
                setLoginLoading(false);
                return;
            }

            if (isDemoMode) {
                // 演示模式：任何非空輸入都允許登入
                setCurrentCommunityByEmailAsync(email).then(()=> enterApp());
            } else {
                // 真實 Firebase 登入
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    // 狀態監聽器會處理頁面切換
                } catch (error) {
                    console.warn("Login failed:", error);
                    if (error && error.code === 'auth/network-request-failed') {
                        isDemoMode = true;
                        loginError.classList.remove('hidden');
                        loginError.innerHTML = `<i class="fa-solid fa-circle-exclamation mr-1"></i> 網路異常，切換為離線預覽模式`;
                        setCurrentCommunityByEmailAsync(email).then(()=> setTimeout(() => enterApp(), 300));
                        updateConnectionStatus();
                    } else {
                        // 允許本機帳號作為後備登入
                        const handled = tryLocalLogin(email, password);
                        if (!handled) {
                            if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                                // 如果是 Firebase 帳號錯誤，但本機帳號也失敗，就顯示「帳號或密碼錯誤」
                                loginError.classList.remove('hidden');
                                loginError.innerHTML = `<i class="fa-solid fa-circle-exclamation mr-1"></i> 帳號或密碼錯誤`;
                            } else {
                                loginError.classList.remove('hidden');
                                loginError.innerHTML = `<i class="fa-solid fa-circle-exclamation mr-1"></i> ${error.message}`;
                            }
                        }
                    }
                    setLoginLoading(false);
                }
            }
        });


        

        // 3. 監聽認證狀態 (僅在 Firebase 初始化成功時有效)
        if (!isDemoMode && auth) {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    const email = user.email || '';
                    localStorage.setItem('currentUserEmail', email);
                    setCurrentCommunityByEmailAsync(email).then(()=> enterApp());
                } else {
                    exitApp();
                }
            });
        }

        // 進入主程式
        function enterApp() {
            loginView.classList.add('hidden');
            mainApp.classList.remove('hidden');
            // 這裡可以觸發資料加載
            loadDashboardData();
            setLoginLoading(false);
            localStorage.setItem('persistLogin','true');
            localStorage.setItem('lastLoginMode', isDemoMode ? 'demo' : 'firebase');
            applyCommunityToUI();
            updateUserDisplayName();
            attachMainLogoPermission();
        }

        // 登出/離開主程式
        function exitApp() {
            loginView.classList.remove('hidden');
            mainApp.classList.add('hidden');
            if (loginView) loginView.style.visibility = 'visible';
            loginForm.reset();
            loginError.classList.add('hidden');
            localStorage.removeItem('persistLogin');
            localStorage.removeItem('lastLoginMode');
            localStorage.removeItem('currentCommunityCode');
            localStorage.removeItem('currentCommunityName');
            localStorage.removeItem('currentUserEmail');
            const savedRemember = localStorage.getItem('rememberMe') === 'true';
            if (savedRemember) {
                const savedEmail = localStorage.getItem('rememberEmail') || '';
                if (emailInput) emailInput.value = savedEmail;
                if (rememberMe) rememberMe.checked = true;
            }
            
            // 重置選單
            switchTab('dashboard');
            updateUserDisplayName();
        }

        // 登出功能
        async function logout() {
            try {
                if (!isDemoMode && auth && auth.currentUser) {
                    await auth.signOut();
                }
            } catch (e) {
                console.warn('Logout error:', e);
            }
            exitApp();
        }

        // ==========================================
        // 頁面切換邏輯
        // ==========================================
        
        const SUBTAB_CONFIG = {
            'dashboard': [],
            'income': ['收入明細','收入設定'],
            'expense': ['支出明細','支出設定'],
            'bank': ['銀行明細','零用金明細','定存明細','銀行設定'],
            'residents': ['住戶明細','住戶設定'],
            'reports': ['日報表','月報表','年報表','報表設定'],
            'settings': ['一般設定','社區帳號','備份還原']
        };

        function renderSubtabs(tabId) {
            const bar = document.getElementById('subtab-bar');
            if (!bar) return;
            const items = SUBTAB_CONFIG[tabId] || [];
            if (items.length === 0) {
                bar.innerHTML = '';
                return;
            }
            bar.innerHTML = items.map((label, idx) => {
                const id = 'subtab-' + tabId + '-' + idx;
                return '<a id="' + id + '" href="#" class="subtab-item h-full flex items-center px-3 text-gray-700 hover:text-red-700 border-b-2 border-transparent">' + label + '</a>';
            }).join('');
            const anchors = Array.from(bar.querySelectorAll('.subtab-item'));
            anchors.forEach(a => {
                a.addEventListener('click', e => {
                    e.preventDefault();
                    setActiveSubtab(a);
                });
            });
            setActiveSubtab(anchors[0]);
        }

        function setActiveSubtab(el) {
            if (!el) return;
            const bar = document.getElementById('subtab-bar');
            if (!bar) return;
            bar.querySelectorAll('.subtab-item').forEach(a => {
                a.classList.remove('text-red-700','border-red-700');
                a.classList.add('text-gray-700');
            });
            el.classList.add('text-red-700','border-red-700');
            el.classList.remove('text-gray-700');
            const parts = (el.id||'').split('-');
            const tab = parts[1];
            const idx = parseInt(parts[2]||'0');
            if (tab === 'income'){
                const d = document.getElementById('income-detail-view');
                const s = document.getElementById('income-settings-view');
                if (d && s){ d.classList.toggle('hidden', idx!==0); s.classList.toggle('hidden', idx!==1); if (idx===1) renderIncomeSettings(); }
            } else if (tab === 'expense'){
                const d2 = document.getElementById('expense-detail-view');
                const s2 = document.getElementById('expense-settings-view');
                if (d2 && s2){ d2.classList.toggle('hidden', idx!==0); s2.classList.toggle('hidden', idx!==1); if (idx===1) renderExpenseSettings(); }
            } else if (tab === 'bank'){
                const bd = document.getElementById('bank-detail-view');
                const bs = document.getElementById('bank-settings-view');
                if (bd && bs){ bd.classList.toggle('hidden', idx!==0); bs.classList.toggle('hidden', idx!==3); if (idx===3) renderBankSettings(); }
            } else if (tab === 'residents'){
                const rd = document.getElementById('residents-detail-view');
                const rs = document.getElementById('residents-settings-view');
                if (rd && rs){ rd.classList.toggle('hidden', idx!==0); rs.classList.toggle('hidden', idx!==1); if (idx===1) renderResidentsSettings(); }
            }
        }

        function tryLocalLogin(email, password) {
            const accounts = getAccounts();
            const acc = accounts.find(a => a.email === email);
            if (!acc) return false;
            if (String(acc.phone).trim() === String(password).trim()) {
                setCurrentCommunityByEmail(email);
                localStorage.setItem('currentUserEmail', email);
                localStorage.setItem('persistLogin','true');
                localStorage.setItem('lastLoginMode','local');
                enterApp('local');
                return true;
            } else {
                loginError.classList.remove('hidden');
                loginError.innerHTML = `<i class="fa-solid fa-circle-exclamation mr-1"></i> 密碼錯誤`;
                setLoginLoading(false);
                return true; // 已處理（顯示錯誤），不再進行 Firebase 嘗試
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-red-800', 'border-white');
                el.classList.add('border-transparent');
            });
            const activeNav = document.getElementById('nav-' + tabId);
            if(activeNav) {
                activeNav.classList.add('bg-red-800', 'border-white');
                activeNav.classList.remove('border-transparent');
            }

            document.querySelectorAll('.content-view').forEach(el => el.classList.add('hidden'));
            const viewEl = document.getElementById('view-' + tabId);
            if (viewEl) viewEl.classList.remove('hidden');

            const titles = {
                'dashboard': '<i class="fa-solid fa-chart-pie mr-2 text-red-600"></i> 財務總覽',
                'income': '<i class="fa-solid fa-hand-holding-dollar mr-2 text-red-600"></i> 收入管理',
                'expense': '<i class="fa-solid fa-file-invoice-dollar mr-2 text-red-600"></i> 支出管理',
                'reports': '<i class="fa-solid fa-print mr-2 text-red-600"></i> 報表中心',
                'bank': '<i class="fa-solid fa-building-columns mr-2 text-red-600"></i> 銀行',
                'residents': '<i class="fa-solid fa-users mr-2 text-red-600"></i> 住戶資料',
                'settings': '<i class="fa-solid fa-gear mr-2 text-red-600"></i> 系統設定'
            };
            document.getElementById('page-title').innerHTML = titles[tabId] || '系統頁面';
            renderSubtabs(tabId);
        }

        // ==========================================
        // 資料模擬與 Firestore 整合範例
        // ==========================================

        async function loadDashboardData() {
            // 如果是真實環境且有登入，可以從 Firestore 抓取資料
            if (!isDemoMode && db && auth.currentUser) {
                // 範例：從 Firestore 讀取交易 (須確保有建立對應集合)
                /*
                const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('transactions').limit(5).get();
                // 處理資料並更新 UI...
                */
               console.log("Fetch data from Firestore...");
            } else {
                // Demo 模式不需要做什麼，HTML 已經有假資料了
            }
        }

        function setCurrentCommunityByEmail(email){
            const accounts = getAccounts();
            const acc = accounts.find(a => a.email === email);
            const communities = getCommunities();
            let name = '西北保全社區';
            let code = 'NW001';
            if (acc) {
                name = acc.community;
                const found = communities.find(c => c.name === name);
                if (found) code = found.code;
            } else {
                const def = communities[0];
                if (def) { name = def.name; code = def.code; }
            }
            localStorage.setItem('currentCommunityName', name);
            localStorage.setItem('currentCommunityCode', code);
        }

        async function setCurrentCommunityByEmailAsync(email){
            let name = '西北保全社區';
            let code = 'NW001';
            if (useCloud()){
                const q = await db.collection('accounts').where('email','==',email).limit(1).get();
                if (!q.empty){
                    const acc = q.docs[0].data();
                    name = acc.community || name;
                    const c = await db.collection('communities').where('name','==',name).limit(1).get();
                    if (!c.empty){ code = (c.docs[0].data().code || c.docs[0].id); }
                }
            } else {
                setCurrentCommunityByEmail(email);
                name = localStorage.getItem('currentCommunityName') || name;
                code = localStorage.getItem('currentCommunityCode') || code;
            }
            localStorage.setItem('currentCommunityName', name);
            localStorage.setItem('currentCommunityCode', code);
        }

        function applyCommunityToUI(){
            const name = localStorage.getItem('currentCommunityName') || '西北保全社區';
            const span = document.getElementById('sidebar-community-name');
            if (span) span.textContent = name;
        }

        const settingsModal = document.getElementById('settings-modal');
        const tabAccountsBtn = document.getElementById('settings-tab-accounts');
        const tabCommunitiesBtn = document.getElementById('settings-tab-communities');
        const viewAccounts = document.getElementById('settings-view-accounts');
        const viewCommunities = document.getElementById('settings-view-communities');
        const settingsClose = document.getElementById('settings-close');
        const loginLogo = document.getElementById('login-logo');
        const mainLogo = document.getElementById('main-logo');
        const btnAddAccount = document.getElementById('btn-add-account');
        const btnAddCommunity = document.getElementById('btn-add-community');
        const modalAddAccount = document.getElementById('modal-add-account');
        const modalAddCommunity = document.getElementById('modal-add-community');
        const inputAccountCommunity = document.getElementById('input-account-community');
        const inputAccountName = document.getElementById('input-account-name');
        const inputAccountEmail = document.getElementById('input-account-email');
        const inputAccountPhone = document.getElementById('input-account-phone');
        const confirmAddAccount = document.getElementById('confirm-add-account');
        const cancelAddAccount = document.getElementById('cancel-add-account');
        const inputCommunityCode = document.getElementById('input-community-code');
        const inputCommunityName = document.getElementById('input-community-name');
        const confirmAddCommunity = document.getElementById('confirm-add-community');
        const cancelAddCommunity = document.getElementById('cancel-add-community');
        const accountsTbody = document.getElementById('accounts-tbody');
        const communitiesTbody = document.getElementById('communities-tbody');
        const communitySwitcherModal = document.getElementById('community-switcher-modal');
        const communitySwitcherList = document.getElementById('community-switcher-list');
        const communitySwitcherClose = document.getElementById('community-switcher-close');
        const modalSettingsPass = document.getElementById('modal-settings-password');
        const settingsPassInput = document.getElementById('settings-pass-input');
        const settingsPassError = document.getElementById('settings-pass-error');
        const settingsPassConfirm = document.getElementById('settings-pass-confirm');
        const settingsPassCancel = document.getElementById('settings-pass-cancel');

        function getAccounts(){
            try { return JSON.parse(localStorage.getItem('admin_accounts')||'[]'); } catch(e){ return []; }
        }
        function setAccounts(arr){ localStorage.setItem('admin_accounts', JSON.stringify(arr)); }
        function getCommunities(){
            try { return JSON.parse(localStorage.getItem('communities')||'[]'); } catch(e){ return []; }
        }
        function setCommunities(arr){ localStorage.setItem('communities', JSON.stringify(arr)); }
        function useCloud(){ 
            const mode = localStorage.getItem('lastLoginMode');
            if (mode === 'local') return false;
            return !!db && cloudAvailable; 
        }
        async function fetchCommunities(){
            if (useCloud()){
                const snap = await db.collection('communities').get();
                return snap.docs.map(d=>({code:(d.data().code||d.id), name:d.data().name||''}));
            }
            return getCommunities();
        }
        async function saveCommunity(code,name,forceLocal=false){
            if (useCloud() && !forceLocal){
                await db.collection('communities').doc(code).set({code,name});
            } else {
                const arr = getCommunities();
                arr.push({code,name});
                setCommunities(arr);
            }
        }
        async function updateCommunity(code,name,forceLocal=false){
            if (useCloud() && !forceLocal){
                await db.collection('communities').doc(code).set({code,name},{merge:true});
            } else {
                const arr = getCommunities();
                const idx = arr.findIndex(x=>x.code===code);
                if (idx>=0){ arr[idx].name = name; setCommunities(arr); }
            }
        }
        async function deleteCommunity(code,forceLocal=false){
            if (useCloud() && !forceLocal){
                await db.collection('communities').doc(code).delete();
            } else {
                const arr = getCommunities().filter(x=>x.code!==code);
                setCommunities(arr);
            }
        }
        async function fetchAccounts(){
            if (useCloud()){
                const snap = await db.collection('accounts').get();
                return snap.docs.map(d=>({id:d.data().id||d.id, community:d.data().community||'', name:d.data().name||'', email:d.data().email||'', phone:d.data().phone||''}));
            }
            return getAccounts();
        }
        async function saveAccount(acc,forceLocal=false){
            if (useCloud() && !forceLocal){
                await db.collection('accounts').doc(acc.id).set(acc);
            } else {
                const arr = getAccounts(); arr.push(acc); setAccounts(arr);
            }
        }
        async function updateAccount(acc,forceLocal=false){
            if (useCloud() && !forceLocal){
                await db.collection('accounts').doc(acc.id).set(acc,{merge:true});
            } else {
                const arr = getAccounts(); const idx = arr.findIndex(x=>x.id===acc.id); if (idx>=0){ arr[idx]=acc; setAccounts(arr); }
            }
        }
        async function deleteAccountByIndex(idx,forceLocal=false){
            if (useCloud() && !forceLocal){
                const arr = await fetchAccounts(); const acc = arr[idx]; if (acc){ await db.collection('accounts').doc(acc.id).delete(); }
            } else {
                const arr = getAccounts(); arr.splice(idx,1); setAccounts(arr);
            }
        }

        function ensureDefaults(){
            let c = getCommunities();
            if (c.length === 0) { c = [{code:'NW001', name:'西北保全社區'}]; setCommunities(c); }
            let a = getAccounts();
            if (a.length === 0) { a = [{id: genAccountId(), community:'西北保全社區', name:'管理員', email:'admin@example.com', phone:'0912345678'}]; setAccounts(a); }
        }
        function genAccountId(){
            const d = new Date();
            const ymd = d.getFullYear().toString()+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0');
            const a = getAccounts().filter(x=>x.id.startsWith(ymd));
            const next = a.length+1;
            return ymd+String(next).padStart(2,'0');
        }
        async function renderCommunityOptions(){
            const c = await fetchCommunities();
            inputAccountCommunity.innerHTML = c.map(x=>'<option value="'+x.name+'">'+x.name+'</option>').join('');
        }
        async function renderAccounts(){
            const arr = await fetchAccounts();
            accountsTbody.innerHTML = arr.map((x,i)=>{
                return '<tr><td class="px-4 py-2">'+x.id+'</td><td class="px-4 py-2">'+x.community+'</td><td class="px-4 py-2">'+x.name+'</td><td class="px-4 py-2">'+x.email+'</td><td class="px-4 py-2">'+x.phone+'</td><td class="px-4 py-2"><button data-i="'+i+'" class="edit-account text-blue-600 mr-2">編輯</button><button data-i="'+i+'" class="delete-account text-red-600">刪除</button></td></tr>';
            }).join('');
            accountsTbody.querySelectorAll('.delete-account').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    const idx = parseInt(btn.getAttribute('data-i')); deleteAccountByIndex(idx).then(renderAccounts);
                });
            });
            accountsTbody.querySelectorAll('.edit-account').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    const idx = parseInt(btn.getAttribute('data-i'));
                    fetchAccounts().then(arr2 => {
                        const item = arr2[idx];
                        inputAccountCommunity.value = item.community; 
                        inputAccountName.value = item.name; 
                        inputAccountEmail.value = item.email; 
                        inputAccountPhone.value = item.phone;
                        
                        // Switch to Edit Mode
                        const title = modalAddAccount.querySelector('h4');
                        if (title) title.textContent = '編輯帳號';
                        confirmAddAccount.textContent = '確認';

                        modalAddAccount.classList.remove('hidden');
                        confirmAddAccount.onclick = async () => {
                            item.community = inputAccountCommunity.value; 
                            item.name = inputAccountName.value.trim(); 
                            item.email = inputAccountEmail.value.trim(); 
                            item.phone = inputAccountPhone.value.trim(); 
                            await updateAccount(item); 
                            modalAddAccount.classList.add('hidden'); 
                            renderAccounts();
                        };
                        cancelAddAccount.onclick = () => { modalAddAccount.classList.add('hidden'); };
                    });
                });
            });
        }
        async function renderCommunities(){
            const arr = await fetchCommunities();
            communitiesTbody.innerHTML = arr.map((x,i)=>{
                return '<tr><td class="px-4 py-2">'+x.code+'</td><td class="px-4 py-2">'+x.name+'</td><td class="px-4 py-2"><button data-i="'+i+'" class="edit-community text-blue-600 mr-2">編輯</button><button data-i="'+i+'" class="delete-community text-red-600">刪除</button></td></tr>';
            }).join('');
            communitiesTbody.querySelectorAll('.delete-community').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    const idx = parseInt(btn.getAttribute('data-i'));
                    fetchCommunities().then(arr2 => { const code = arr2[idx].code; deleteCommunity(code).then(()=>{ renderCommunities(); renderCommunityOptions(); }); });
                });
            });
            communitiesTbody.querySelectorAll('.edit-community').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    const idx = parseInt(btn.getAttribute('data-i'));
                    fetchCommunities().then(arr2 => {
                        const item = arr2[idx];
                        inputCommunityCode.value = item.code;
                        inputCommunityName.value = item.name;
                        
                        // Switch to Edit Mode
                        const title = modalAddCommunity.querySelector('h4');
                        if (title) title.textContent = '編輯社區';
                        confirmAddCommunity.textContent = '確認';
                        inputCommunityCode.disabled = true;
                        inputCommunityCode.classList.add('bg-gray-100');

                        modalAddCommunity.classList.remove('hidden');
                        confirmAddCommunity.onclick = () => {
                            updateCommunity(inputCommunityCode.value, inputCommunityName.value).then(()=>{ modalAddCommunity.classList.add('hidden'); renderCommunities(); renderCommunityOptions(); });
                        };
                        cancelAddCommunity.onclick = () => { modalAddCommunity.classList.add('hidden'); };
                    });
                });
            });
        }
        async function ensureAuthForSettings(){
            if (useCloud()){
                try {
                    if (!auth.currentUser) {
                        await auth.signInAnonymously();
                        localStorage.setItem('lastLoginMode','anonymous');
                    }
                } catch(e) {
                    console.warn('Anonymous sign-in failed:', e);
                }
            }
        }
        async function openSettingsModal(defaultTab){
            await ensureAuthForSettings();
            let fallback = false;
            if (useCloud()){
                try {
                    const c = await fetchCommunities();
                    const a = await fetchAccounts();
                    const email = getCurrentUserEmail();
                    const isAdmin = isAdminEmail(email);
                    if (isAdmin) {
                        if (c.length===0){ await saveCommunity('NW001','西北保全社區'); }
                        if (a.length===0){ const seed = {id: genAccountId(), community:'西北保全社區', name:'管理員', email:'admin@example.com', phone:'0912345678'}; await saveAccount(seed); }
                    }
                } catch (e) {
                    console.warn('Open settings cloud fetch failed:', e);
                    cloudAvailable = false;
                    fallback = true;
                }
            }
            if (!useCloud()) {
                ensureDefaults();
            }
            const errBar = document.getElementById('settings-error');
            if (errBar) errBar.classList.toggle('hidden', !fallback);
            await renderCommunityOptions(); await renderAccounts(); await renderCommunities(); settingsModal.classList.remove('hidden');
            activateSettingsTab(defaultTab||'accounts');
        }
        function closeSettingsModal(){ settingsModal.classList.add('hidden'); }
        function activateSettingsTab(which){
            if (which==='accounts'){ viewAccounts.classList.remove('hidden'); viewCommunities.classList.add('hidden'); tabAccountsBtn.classList.add('border-red-700','text-red-700'); tabCommunitiesBtn.classList.remove('border-red-700','text-red-700'); }
            else { viewAccounts.classList.add('hidden'); viewCommunities.classList.remove('hidden'); tabCommunitiesBtn.classList.add('border-red-700','text-red-700'); tabAccountsBtn.classList.remove('border-red-700','text-red-700'); }
        }
        function getGuardPass(){
            const d = new Date();
            const mm = String(d.getMonth()+1).padStart(2,'0');
            const dd = String(d.getDate()).padStart(2,'0');
            return mm+dd+'0217';
        }
        function openSettingsGuard(){
            settingsPassError.classList.add('hidden');
            settingsPassInput.value = '';
            modalSettingsPass.classList.remove('hidden');
        }
        function closeSettingsGuard(){
            modalSettingsPass.classList.add('hidden');
        }

        if (settingsPassCancel){ settingsPassCancel.addEventListener('click', closeSettingsGuard); }
        if (settingsPassConfirm){ settingsPassConfirm.addEventListener('click', ()=>{
            const ok = settingsPassInput.value === getGuardPass();
            if (ok){
                closeSettingsGuard();
                if (loginError){
                    loginError.classList.remove('hidden');
                    loginError.innerHTML = `<i class="fa-solid fa-circle-exclamation mr-1"></i> 雲端權限不足或讀取失敗，改用本機設定`;
                }
                openSettingsModal('communities');
            }
            else { settingsPassError.classList.remove('hidden'); }
        }); }
        if (settingsPassInput){ settingsPassInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ settingsPassConfirm.click(); } }); }

        function getCurrentUserEmail(){
            if (!isDemoMode && auth && auth.currentUser && auth.currentUser.email) return auth.currentUser.email;
            return localStorage.getItem('currentUserEmail') || '';
        }
        function isAdminEmail(email){ 
            if (!email) return false;
            return String(email).trim().toLowerCase() === 'nwapp.eason@gmail.com'; 
        }
        function updateUserDisplayName(){
            const el = document.getElementById('user-display-name');
            if (!el) return;
            const email = getCurrentUserEmail();
            if (isAdminEmail(email)) {
                el.textContent = '系統管理員';
            } else {
                el.textContent = email ? email : '未登入';
            }
        }
        function attachMainLogoPermission(){
            const email = getCurrentUserEmail();
            const ml = document.getElementById('main-logo');
            if (!ml) return;
            ml.classList.remove('cursor-pointer');
            ml.onclick = null;
            if (isAdminEmail(email)){
                ml.classList.add('cursor-pointer');
                ml.onclick = ()=> openSettingsModal();
            }
        }
        async function openCommunitySwitcher(){
            const email = getCurrentUserEmail();
            if (!isAdminEmail(email)) return;
            await ensureAuthForSettings();
            const communities = await fetchCommunities();
            communitySwitcherList.innerHTML = communities.map(c => {
                return '<button data-code="'+c.code+'" data-name="'+c.name+'" class="px-4 py-3 bg-gray-100 hover:bg-red-50 hover:text-red-700 rounded text-left">'+c.name+' <span class="text-xs text-gray-400 ml-2">('+c.code+')</span></button>';
            }).join('');
            communitySwitcherModal.classList.remove('hidden');
            Array.from(communitySwitcherList.querySelectorAll('button')).forEach(btn => {
                btn.addEventListener('click', () => {
                    const code = btn.getAttribute('data-code');
                    const name = btn.getAttribute('data-name');
                    localStorage.setItem('currentCommunityCode', code);
                    localStorage.setItem('currentCommunityName', name);
                    applyCommunityToUI();
                    communitySwitcherModal.classList.add('hidden');
                    switchTab('dashboard');
                });
            });
        }
        if (communitySwitcherClose){ communitySwitcherClose.addEventListener('click', ()=> communitySwitcherModal.classList.add('hidden')); }
        const sidebarCommunityName = document.getElementById('sidebar-community-name');
        if (sidebarCommunityName){ sidebarCommunityName.addEventListener('click', openCommunitySwitcher); }
        if (settingsClose){ settingsClose.addEventListener('click', closeSettingsModal); }
        if (tabAccountsBtn){ tabAccountsBtn.addEventListener('click', ()=> activateSettingsTab('accounts')); }
        if (tabCommunitiesBtn){ tabCommunitiesBtn.addEventListener('click', ()=> activateSettingsTab('communities')); }
        if (btnAddAccount){ btnAddAccount.addEventListener('click', async ()=>{ 
            await ensureAuthForSettings(); 
            await renderCommunityOptions(); 
            inputAccountName.value=''; 
            inputAccountEmail.value=''; 
            inputAccountPhone.value=''; 
            
            // Switch to Add Mode
            const title = modalAddAccount.querySelector('h4');
            if (title) title.textContent = '新增帳號';
            confirmAddAccount.textContent = '新增';
            
            modalAddAccount.classList.remove('hidden'); 
            confirmAddAccount.onclick = async ()=>{ 
                const acc = {
                    id: genAccountId(), 
                    community: inputAccountCommunity.value, 
                    name: inputAccountName.value.trim(), 
                    email: inputAccountEmail.value.trim(), 
                    phone: inputAccountPhone.value.trim()
                }; 
                try { 
                    let forceLocal = false;
                    if (useCloud()){ 
                        const email = getCurrentUserEmail(); 
                        if (!isAdminEmail(email)) {
                            if (confirm('新增帳號失敗：非系統管理員不可新增雲端帳號。\n是否要建立「本機僅有」的帳號？(僅供本機測試用，不會同步到雲端)')) {
                                forceLocal = true;
                            } else {
                                return;
                            }
                        } else {
                           // Admin creating cloud account
                           try {
                               await auth.createUserWithEmailAndPassword(acc.email, acc.phone); 
                           } catch(err) {
                               console.warn("Create cloud user warning:", err);
                               // Continue to save doc even if auth creation fails (e.g. user exists)
                           }
                        }
                    } 
                    await saveAccount(acc, forceLocal); 
                    modalAddAccount.classList.add('hidden'); 
                    renderAccounts(); 
                } catch(e){ 
                    alert('新增帳號失敗：'+(e && e.message ? e.message : e)); 
                } 
            }; 
            cancelAddAccount.onclick = ()=> modalAddAccount.classList.add('hidden'); 
        }); }
        if (btnAddCommunity){ btnAddCommunity.addEventListener('click', async ()=>{ 
            await ensureAuthForSettings(); 
            inputCommunityCode.value=''; 
            inputCommunityName.value=''; 
            
            // Switch to Add Mode
            const title = modalAddCommunity.querySelector('h4');
            if (title) title.textContent = '新增社區';
            confirmAddCommunity.textContent = '新增';
            inputCommunityCode.disabled = false;
            inputCommunityCode.classList.remove('bg-gray-100');

            modalAddCommunity.classList.remove('hidden'); 
            confirmAddCommunity.onclick = async ()=>{ 
                try { 
                    let forceLocal = false;
                    if (useCloud()){ 
                        const email = getCurrentUserEmail(); 
                        if (!isAdminEmail(email)) {
                             if (confirm('新增社區失敗：非系統管理員不可新增雲端社區。\n是否要建立「本機僅有」的社區？(僅供本機測試用，不會同步到雲端)')) {
                                forceLocal = true;
                            } else {
                                return;
                            }
                        } 
                    } 
                    await saveCommunity(inputCommunityCode.value, inputCommunityName.value, forceLocal); 
                    modalAddCommunity.classList.add('hidden'); 
                    renderCommunities(); 
                    renderCommunityOptions(); 
                } catch(e){ 
                    alert('新增社區失敗：'+(e && e.message ? e.message : e)); 
                } 
            }; 
            cancelAddCommunity.onclick = ()=> modalAddCommunity.classList.add('hidden'); 
        }); }

        function getCurrentCommunityCode(){ return localStorage.getItem('currentCommunityCode') || 'NW001'; }
        function lsGet(key){ try { return JSON.parse(localStorage.getItem(key)||'[]'); } catch(e){ return []; } }
        function lsSet(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }
        function incomeKey(kind){ return kind+'_'+getCurrentCommunityCode(); }
        function expenseKey(kind){ return kind+'_'+getCurrentCommunityCode(); }
        function bankKey(){ return 'bank_accounts_'+getCurrentCommunityCode(); }
        function buildingKey(){ return 'buildings_'+getCurrentCommunityCode(); }
        function getIncomeFixed(){ return lsGet(incomeKey('income_fixed')); }
        function setIncomeFixed(arr){ lsSet(incomeKey('income_fixed'), arr); }
        function getIncomeOther(){ return lsGet(incomeKey('income_other')); }
        function setIncomeOther(arr){ lsSet(incomeKey('income_other'), arr); }
        function getExpenseFixed(){ return lsGet(expenseKey('expense_fixed')); }
        function setExpenseFixed(arr){ lsSet(expenseKey('expense_fixed'), arr); }
        function getExpenseOther(){ return lsGet(expenseKey('expense_other')); }
        function setExpenseOther(arr){ lsSet(expenseKey('expense_other'), arr); }
        function getBankAccounts(){ return lsGet(bankKey()); }
        function setBankAccounts(arr){ lsSet(bankKey(), arr); }
        function getBuildings(){ return lsGet(buildingKey()); }
        function setBuildings(arr){ lsSet(buildingKey(), arr); }

        const incomeFixedTbody = document.getElementById('income-fixed-tbody');
        const incomeOtherTbody = document.getElementById('income-other-tbody');
        const expenseFixedTbody = document.getElementById('expense-fixed-tbody');
        const expenseOtherTbody = document.getElementById('expense-other-tbody');
        const btnAddIncomeFixed = document.getElementById('btn-add-income-fixed');
        const btnAddIncomeOther = document.getElementById('btn-add-income-other');
        const btnAddExpenseFixed = document.getElementById('btn-add-expense-fixed');
        const btnAddExpenseOther = document.getElementById('btn-add-expense-other');
        const bankTbody = document.getElementById('bank-tbody');
        const btnAddBank = document.getElementById('btn-add-bank');
        const residentsBuildingsTbody = document.getElementById('residents-buildings-tbody');
        const btnAddBuilding = document.getElementById('btn-add-building');

        let editCtx = null;
        const modalEditItem = document.getElementById('modal-edit-item');
        const inputItemName = document.getElementById('input-item-name');
        const confirmEditItem = document.getElementById('confirm-edit-item');
        const cancelEditItem = document.getElementById('cancel-edit-item');
        const modalEditBank = document.getElementById('modal-edit-bank');
        const inputBankName = document.getElementById('input-bank-name');
        const inputBankBranch = document.getElementById('input-bank-branch');
        const inputBankHolder = document.getElementById('input-bank-holder');
        const inputBankAccount = document.getElementById('input-bank-account');
        const confirmEditBank = document.getElementById('confirm-edit-bank');
        const cancelEditBank = document.getElementById('cancel-edit-bank');
        const modalEditBuilding = document.getElementById('modal-edit-building');
        const inputBuildingName = document.getElementById('input-building-name');
        const confirmEditBuilding = document.getElementById('confirm-edit-building');
        const cancelEditBuilding = document.getElementById('cancel-edit-building');

        function openEditItem(ctx){ editCtx = ctx; inputItemName.value = ctx.value || ''; if (modalEditItem) modalEditItem.classList.remove('hidden'); }
        function closeEditItem(){ editCtx = null; if (modalEditItem) modalEditItem.classList.add('hidden'); }
        function openEditBank(ctx){ editCtx = ctx; if (modalEditBank){ inputBankName.value = ctx.item?.bankName || ''; inputBankBranch.value = ctx.item?.branchName || ''; inputBankHolder.value = ctx.item?.holderName || ''; inputBankAccount.value = ctx.item?.accountNumber || ''; modalEditBank.classList.remove('hidden'); } }
        function closeEditBank(){ editCtx = null; if (modalEditBank) modalEditBank.classList.add('hidden'); }
        function openEditBuilding(ctx){ editCtx = ctx; if (modalEditBuilding){ inputBuildingName.value = ctx.value || ''; modalEditBuilding.classList.remove('hidden'); } }
        function closeEditBuilding(){ editCtx = null; if (modalEditBuilding) modalEditBuilding.classList.add('hidden'); }
        function renderIncomeSettings(){
            if (incomeFixedTbody){ const arr = getIncomeFixed(); incomeFixedTbody.innerHTML = arr.map((x,i)=> '<tr><td class="px-6 py-3">'+x+'</td><td class="px-6 py-3"><button data-i="'+i+'" class="edit-if text-blue-600 mr-2">編輯</button><button data-i="'+i+'" class="del-if text-red-600">刪除</button></td></tr>').join('');
                Array.from(incomeFixedTbody.querySelectorAll('.del-if')).forEach(btn=>{ btn.addEventListener('click', ()=>{ const i = parseInt(btn.getAttribute('data-i')); const arr2 = getIncomeFixed(); arr2.splice(i,1); setIncomeFixed(arr2); renderIncomeSettings(); }); });
                Array.from(incomeFixedTbody.querySelectorAll('.edit-if')).forEach(btn=>{ btn.addEventListener('click', ()=>{ const i = parseInt(btn.getAttribute('data-i')); const arr2 = getIncomeFixed(); openEditItem({kind:'income_fixed', index:i, value:arr2[i]}); }); });
            }
            if (incomeOtherTbody){ const arr = getIncomeOther(); incomeOtherTbody.innerHTML = arr.map((x,i)=> '<tr><td class="px-6 py-3">'+x+'</td><td class="px-6 py-3"><button data-i="'+i+'" class="edit-io text-blue-600 mr-2">編輯</button><button data-i="'+i+'" class="del-io text-red-600">刪除</button></td></tr>').join('');
                Array.from(incomeOtherTbody.querySelectorAll('.del-io')).forEach(btn=>{ btn.addEventListener('click', ()=>{ const i = parseInt(btn.getAttribute('data-i')); const arr2 = getIncomeOther(); arr2.splice(i,1); setIncomeOther(arr2); renderIncomeSettings(); }); });
                Array.from(incomeOtherTbody.querySelectorAll('.edit-io')).forEach(btn=>{ btn.addEventListener('click', ()=>{ const i = parseInt(btn.getAttribute('data-i')); const arr2 = getIncomeOther(); openEditItem({kind:'income_other', index:i, value:arr2[i]}); }); });
            }
        }
        function renderExpenseSettings(){
            if (expenseFixedTbody){ const arr = getExpenseFixed(); expenseFixedTbody.innerHTML = arr.map((x,i)=> '<tr><td class="px-6 py-3">'+x+'</td><td class="px-6 py-3"><button data-i="'+i+'" class="edit-ef text-blue-600 mr-2">編輯</button><button data-i="'+i+'" class="del-ef text-red-600">刪除</button></td></tr>').join('');
                Array.from(expenseFixedTbody.querySelectorAll('.del-ef')).forEach(btn=>{ btn.addEventListener('click', ()=>{ const i = parseInt(btn.getAttribute('data-i')); const arr2 = getExpenseFixed(); arr2.splice(i,1); setExpenseFixed(arr2); renderExpenseSettings(); }); });
                Array.from(expenseFixedTbody.querySelectorAll('.edit-ef')).forEach(btn=>{ btn.addEventListener('click', ()=>{ const i = parseInt(btn.getAttribute('data-i')); const arr2 = getExpenseFixed(); openEditItem({kind:'expense_fixed', index:i, value:arr2[i]}); }); });
            }
            if (expenseOtherTbody){ const arr = getExpenseOther(); expenseOtherTbody.innerHTML = arr.map((x,i)=> '<tr><td class="px-6 py-3">'+x+'</td><td class="px-6 py-3"><button data-i="'+i+'" class="edit-eo text-blue-600 mr-2">編輯</button><button data-i="'+i+'" class="del-eo text-red-600">刪除</button></td></tr>').join('');
                Array.from(expenseOtherTbody.querySelectorAll('.del-eo')).forEach(btn=>{ btn.addEventListener('click', ()=>{ const i = parseInt(btn.getAttribute('data-i')); const arr2 = getExpenseOther(); arr2.splice(i,1); setExpenseOther(arr2); renderExpenseSettings(); }); });
                Array.from(expenseOtherTbody.querySelectorAll('.edit-eo')).forEach(btn=>{ btn.addEventListener('click', ()=>{ const i = parseInt(btn.getAttribute('data-i')); const arr2 = getExpenseOther(); openEditItem({kind:'expense_other', index:i, value:arr2[i]}); }); });
            }
        }
        function renderBankSettings(){
            if (bankTbody){ const arr = getBankAccounts(); bankTbody.innerHTML = arr.map((x,i)=> '<tr><td class="px-6 py-3">'+(x.bankName||'')+'</td><td class="px-6 py-3">'+(x.branchName||'')+'</td><td class="px-6 py-3">'+(x.holderName||'')+'</td><td class="px-6 py-3">'+(x.accountNumber||'')+'</td><td class="px-6 py-3"><button data-i="'+i+'" class="edit-bank text-blue-600 mr-2">編輯</button><button data-i="'+i+'" class="del-bank text-red-600">刪除</button></td></tr>').join('');
                Array.from(bankTbody.querySelectorAll('.del-bank')).forEach(btn=>{ btn.addEventListener('click', ()=>{ const i = parseInt(btn.getAttribute('data-i')); const arr2 = getBankAccounts(); arr2.splice(i,1); setBankAccounts(arr2); renderBankSettings(); }); });
                Array.from(bankTbody.querySelectorAll('.edit-bank')).forEach(btn=>{ btn.addEventListener('click', ()=>{ const i = parseInt(btn.getAttribute('data-i')); const arr2 = getBankAccounts(); openEditBank({kind:'bank', index:i, item:arr2[i]}); }); });
            }
        }
        function renderResidentsSettings(){
            if (residentsBuildingsTbody){ const arr = getBuildings(); residentsBuildingsTbody.innerHTML = arr.map((x,i)=> '<tr><td class="px-6 py-3">'+x+'</td><td class="px-6 py-3"><button data-i="'+i+'" class="edit-building text-blue-600 mr-2">編輯</button><button data-i="'+i+'" class="del-building text-red-600">刪除</button></td></tr>').join('');
                Array.from(residentsBuildingsTbody.querySelectorAll('.del-building')).forEach(btn=>{ btn.addEventListener('click', ()=>{ const i = parseInt(btn.getAttribute('data-i')); const arr2 = getBuildings(); arr2.splice(i,1); setBuildings(arr2); renderResidentsSettings(); }); });
                Array.from(residentsBuildingsTbody.querySelectorAll('.edit-building')).forEach(btn=>{ btn.addEventListener('click', ()=>{ const i = parseInt(btn.getAttribute('data-i')); const arr2 = getBuildings(); openEditBuilding({kind:'building', index:i, value:arr2[i]}); }); });
            }
        }
        function ensureDefaultsIncomeExpense(){
            if (getIncomeFixed().length===0) setIncomeFixed(['管理費']);
            if (getIncomeOther().length===0) setIncomeOther(['停車費']);
            if (getExpenseFixed().length===0) setExpenseFixed(['清潔費']);
            if (getExpenseOther().length===0) setExpenseOther(['維修費']);
        }
        function ensureDefaultsBankResidents(){
            if (getBankAccounts().length===0) setBankAccounts([{bankName:'台新銀行', branchName:'松德分行', holderName:'社區管理委員會', accountNumber:'123-456-7890'}]);
            if (getBuildings().length===0) setBuildings(['A棟','B棟']);
        }
        ensureDefaultsBankResidents();
        ensureDefaultsIncomeExpense();
        if (btnAddIncomeFixed){ btnAddIncomeFixed.addEventListener('click', ()=> openEditItem({kind:'income_fixed', index:-1, value:''})); }
        if (btnAddIncomeOther){ btnAddIncomeOther.addEventListener('click', ()=> openEditItem({kind:'income_other', index:-1, value:''})); }
        if (btnAddExpenseFixed){ btnAddExpenseFixed.addEventListener('click', ()=> openEditItem({kind:'expense_fixed', index:-1, value:''})); }
        if (btnAddExpenseOther){ btnAddExpenseOther.addEventListener('click', ()=> openEditItem({kind:'expense_other', index:-1, value:''})); }
        if (confirmEditItem){ confirmEditItem.addEventListener('click', ()=>{ if(!editCtx) return; const name = (inputItemName.value||'').trim(); if(!name){ closeEditItem(); return; } if (editCtx.kind==='income_fixed'){ const arr = getIncomeFixed(); if (editCtx.index>=0) arr[editCtx.index]=name; else arr.push(name); setIncomeFixed(arr); renderIncomeSettings(); }
            else if (editCtx.kind==='income_other'){ const arr = getIncomeOther(); if (editCtx.index>=0) arr[editCtx.index]=name; else arr.push(name); setIncomeOther(arr); renderIncomeSettings(); }
            else if (editCtx.kind==='expense_fixed'){ const arr = getExpenseFixed(); if (editCtx.index>=0) arr[editCtx.index]=name; else arr.push(name); setExpenseFixed(arr); renderExpenseSettings(); }
            else if (editCtx.kind==='expense_other'){ const arr = getExpenseOther(); if (editCtx.index>=0) arr[editCtx.index]=name; else arr.push(name); setExpenseOther(arr); renderExpenseSettings(); }
            closeEditItem(); }); }
        if (cancelEditItem){ cancelEditItem.addEventListener('click', closeEditItem); }
        if (btnAddBank){ btnAddBank.addEventListener('click', ()=> openEditBank({kind:'bank', index:-1, item:{}})); }
        if (confirmEditBank){ confirmEditBank.addEventListener('click', ()=>{ if(!editCtx) return; const item = { bankName: (inputBankName.value||'').trim(), branchName: (inputBankBranch.value||'').trim(), holderName: (inputBankHolder.value||'').trim(), accountNumber: (inputBankAccount.value||'').trim() }; const arr = getBankAccounts(); if (editCtx.index>=0) arr[editCtx.index]=item; else arr.push(item); setBankAccounts(arr); closeEditBank(); renderBankSettings(); }); }
        if (cancelEditBank){ cancelEditBank.addEventListener('click', closeEditBank); }
        if (btnAddBuilding){ btnAddBuilding.addEventListener('click', ()=> openEditBuilding({kind:'building', index:-1, value:''})); }
        if (confirmEditBuilding){ confirmEditBuilding.addEventListener('click', ()=>{ if(!editCtx) return; const name = (inputBuildingName.value||'').trim(); const arr = getBuildings(); if (editCtx.index>=0) arr[editCtx.index]=name; else arr.push(name); setBuildings(arr); closeEditBuilding(); renderResidentsSettings(); }); }
        if (cancelEditBuilding){ cancelEditBuilding.addEventListener('click', closeEditBuilding); }

    </script>
</body>
</html>
